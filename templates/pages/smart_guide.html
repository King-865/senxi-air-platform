{% extends "base.html" %}

{% block title %}æ™ºèƒ½å¯¼è´­{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-br from-accent-50 via-white to-primary-50 py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center space-x-2 px-4 py-2 bg-accent-100 text-accent-700 rounded-full mb-4">
                <i data-lucide="sparkles" class="w-4 h-4"></i>
                <span class="text-sm font-medium">AIæ™ºèƒ½å¯¼è´­</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
                å®šåˆ¶æ‚¨çš„ç©ºæ°”ç®¡ç†æ–¹æ¡ˆ
            </h1>
            <p class="text-xl text-gray-600">
                å›ç­”å‡ ä¸ªç®€å•é—®é¢˜ï¼Œè·å–ä¸“å±æ¨è
            </p>
        </div>
        
        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between text-sm text-gray-500 mb-2">
                <span>è¿›åº¦</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-accent-500 to-primary-500 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Chat Container -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-accent-600 to-primary-600 px-6 py-4 flex items-center space-x-4">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                    <i data-lucide="bot" class="w-7 h-7 text-white"></i>
                </div>
                <div>
                    <h3 class="text-white font-semibold text-lg">æ™ºèƒ½ç©ºæ°”é¡¾é—®</h3>
                    <p class="text-white/80 text-sm">ä¸ºæ‚¨é‡èº«å®šåˆ¶ç©ºæ°”ç®¡ç†æ–¹æ¡ˆ</p>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div id="guide-messages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
                <!-- Messages will be inserted here -->
            </div>
            
            <!-- Options Area -->
            <div id="guide-options" class="px-6 py-4 border-t bg-white">
                <!-- Options will be inserted here -->
            </div>
            
            <!-- Input Area -->
            <div id="guide-input-area" class="px-6 py-4 border-t bg-white hidden">
                <div class="flex space-x-3">
                    <input type="text" id="guide-input" 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent-500"
                           placeholder="è¾“å…¥æ‚¨çš„å›ç­”...">
                    <button id="guide-send" class="px-6 py-3 bg-accent-600 text-white rounded-xl hover:bg-accent-700 transition-colors flex items-center space-x-2">
                        <span>å‘é€</span>
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Recommendation Result (Hidden initially) -->
        <div id="recommendation-result" class="mt-8 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check-circle" class="w-8 h-8 text-primary-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">ä¸ºæ‚¨æ¨èçš„ç©ºæ°”ç®¡ç†æ–¹æ¡ˆ</h2>
                    <p class="text-gray-600">æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä»¬ç²¾å¿ƒæŒ‘é€‰äº†ä»¥ä¸‹äº§å“</p>
                </div>
                
                <!-- User Profile Summary -->
                <div id="profile-summary" class="bg-gray-50 rounded-xl p-6 mb-8">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="user" class="w-5 h-5 mr-2 text-accent-600"></i>
                        æ‚¨çš„éœ€æ±‚æ‘˜è¦
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="profile-details">
                        <!-- Profile details will be inserted here -->
                    </div>
                </div>
                
                <!-- Recommended Products -->
                <div id="recommended-products" class="space-y-6">
                    <!-- Products will be inserted here -->
                </div>
                
                <!-- Actions -->
                <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                    <button id="restart-guide" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center space-x-2">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        <span>é‡æ–°æµ‹è¯•</span>
                    </button>
                    <a href="/products" class="px-6 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors flex items-center justify-center space-x-2">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span>æŸ¥çœ‹å…¨éƒ¨äº§å“</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Smart Guide System
class SmartGuide {
    constructor() {
        this.currentStep = 0;
        this.userProfile = {};
        this.messagesContainer = document.getElementById('guide-messages');
        this.optionsContainer = document.getElementById('guide-options');
        this.inputArea = document.getElementById('guide-input-area');
        this.progressBar = document.getElementById('progress-bar');
        this.progressText = document.getElementById('progress-text');
        this.resultContainer = document.getElementById('recommendation-result');
        
        this.init();
    }
    
    init() {
        // Start the guide
        this.startGuide();
        
        // Event listeners
        document.getElementById('guide-send')?.addEventListener('click', () => this.handleInput());
        document.getElementById('guide-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleInput();
        });
        document.getElementById('restart-guide')?.addEventListener('click', () => this.restart());
    }
    
    async startGuide() {
        try {
            const response = await fetch('/api/guide/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            this.displayMessage(data.message, 'bot');
            this.currentStep = 1;
            this.showStep1Options();
        } catch (error) {
            console.error('Error starting guide:', error);
            this.displayMessage('æ‚¨å¥½ï¼æˆ‘æ˜¯æ£®ç³»æ™ºéŸµçš„æ™ºèƒ½ç©ºæ°”é¡¾é—®ã€‚è®©æˆ‘ä»¬å¼€å§‹ä¸ºæ‚¨å®šåˆ¶ä¸“å±çš„ç©ºæ°”ç®¡ç†æ–¹æ¡ˆå§ï¼', 'bot');
            this.currentStep = 1;
            this.showStep1Options();
        }
    }
    
    displayMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'bot' 
            ? 'flex items-start space-x-3' 
            : 'flex items-start space-x-3 flex-row-reverse';
        
        const avatar = sender === 'bot'
            ? `<div class="w-10 h-10 bg-accent-100 rounded-full flex items-center justify-center flex-shrink-0">
                   <i data-lucide="bot" class="w-5 h-5 text-accent-600"></i>
               </div>`
            : `<div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0">
                   <i data-lucide="user" class="w-5 h-5 text-primary-600"></i>
               </div>`;
        
        const bubbleClass = sender === 'bot'
            ? 'bg-white border border-gray-200 text-gray-800'
            : 'bg-accent-600 text-white';
        
        messageDiv.innerHTML = `
            ${avatar}
            <div class="max-w-md ${bubbleClass} rounded-2xl px-4 py-3 shadow-sm">
                <p>${text}</p>
            </div>
        `;
        
        this.messagesContainer.appendChild(messageDiv);
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        
        // Re-initialize Lucide icons
        lucide.createIcons();
    }
    
    updateProgress(percent) {
        this.progressBar.style.width = `${percent}%`;
        this.progressText.textContent = `${percent}%`;
    }
    
    showOptions(options, multiSelect = false) {
        this.optionsContainer.innerHTML = '';
        
        const wrapper = document.createElement('div');
        wrapper.className = 'flex flex-wrap gap-2';
        
        options.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'px-4 py-2 bg-gray-100 hover:bg-accent-100 text-gray-700 hover:text-accent-700 rounded-xl transition-colors flex items-center space-x-2';
            btn.dataset.value = option.value;
            
            let content = '';
            if (option.icon) {
                content += `<span>${option.icon}</span>`;
            }
            content += `<span>${option.label}</span>`;
            if (option.description) {
                content += `<span class="text-xs text-gray-500">(${option.description})</span>`;
            }
            if (option.range) {
                content += `<span class="text-xs text-gray-500">${option.range}</span>`;
            }
            
            btn.innerHTML = content;
            
            if (multiSelect) {
                btn.addEventListener('click', () => this.toggleOption(btn));
            } else {
                btn.addEventListener('click', () => this.selectOption(option.value, option.label));
            }
            
            wrapper.appendChild(btn);
        });
        
        if (multiSelect) {
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'mt-4 w-full px-4 py-3 bg-accent-600 text-white rounded-xl hover:bg-accent-700 transition-colors';
            confirmBtn.textContent = 'ç¡®è®¤é€‰æ‹©';
            confirmBtn.addEventListener('click', () => this.confirmMultiSelect());
            
            this.optionsContainer.appendChild(wrapper);
            this.optionsContainer.appendChild(confirmBtn);
        } else {
            this.optionsContainer.appendChild(wrapper);
        }
    }
    
    toggleOption(btn) {
        btn.classList.toggle('bg-accent-600');
        btn.classList.toggle('text-white');
        btn.classList.toggle('bg-gray-100');
        btn.classList.toggle('text-gray-700');
        btn.dataset.selected = btn.classList.contains('bg-accent-600') ? 'true' : 'false';
    }
    
    async selectOption(value, label) {
        this.displayMessage(label, 'user');
        await this.processStep(value);
    }
    
    async confirmMultiSelect() {
        const selected = Array.from(this.optionsContainer.querySelectorAll('button[data-selected="true"]'));
        if (selected.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹');
            return;
        }
        
        const values = selected.map(btn => btn.dataset.value);
        const labels = selected.map(btn => btn.textContent.trim());
        
        this.displayMessage(labels.join('ã€'), 'user');
        await this.processStep(values.join(','));
    }
    
    async processStep(value) {
        try {
            const response = await fetch('/api/guide/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: value,
                    step: this.currentStep
                })
            });
            const data = await response.json();
            
            this.updateProgress(data.progress || 0);
            
            if (data.type === 'recommendation') {
                this.showRecommendations(data);
            } else {
                this.displayMessage(data.message, 'bot');
                this.currentStep = data.next_step;
                this.showStepOptions(data);
            }
        } catch (error) {
            console.error('Error processing step:', error);
            this.handleLocalStep(value);
        }
    }
    
    handleLocalStep(value) {
        // Local fallback logic
        switch (this.currentStep) {
            case 1:
                this.userProfile.area = value;
                this.displayMessage(`å¥½çš„ï¼Œæ‚¨çš„ç©ºé—´é¢ç§¯æ˜¯${value}å¹³æ–¹ç±³ã€‚è¯·é—®æ‚¨å±…ä½åœ¨å“ªä¸ªåŒºåŸŸï¼Ÿ`, 'bot');
                this.currentStep = 2;
                this.updateProgress(28);
                this.showStep2Options();
                break;
            case 2:
                this.userProfile.region = value;
                this.displayMessage('äº†è§£äº†ã€‚è¯·é—®æ‚¨æœ€å…³æ³¨å“ªäº›ç©ºæ°”é—®é¢˜ï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰', 'bot');
                this.currentStep = 3;
                this.updateProgress(42);
                this.showStep3Options();
                break;
            case 3:
                this.userProfile.problems = value.split(',');
                this.displayMessage('æ˜ç™½äº†ã€‚è¯·é—®å®¶ä¸­ä¸»è¦æœ‰å“ªäº›æˆå‘˜ï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰', 'bot');
                this.currentStep = 4;
                this.updateProgress(56);
                this.showStep4Options();
                break;
            case 4:
                this.userProfile.users = value.split(',');
                this.displayMessage('è¯·é—®æ‚¨ä¸»è¦æƒ³åœ¨å“ªä¸ªç©ºé—´ä½¿ç”¨ç©ºæ°”å‡€åŒ–å™¨ï¼Ÿ', 'bot');
                this.currentStep = 5;
                this.updateProgress(70);
                this.showStep5Options();
                break;
            case 5:
                this.userProfile.space = value;
                this.displayMessage('æœ€åä¸€ä¸ªé—®é¢˜ï¼Œè¯·é—®æ‚¨çš„é¢„ç®—èŒƒå›´æ˜¯ï¼Ÿ', 'bot');
                this.currentStep = 6;
                this.updateProgress(84);
                this.showStep6Options();
                break;
            case 6:
                this.userProfile.budget = value;
                this.updateProgress(100);
                this.generateLocalRecommendation();
                break;
        }
    }
    
    showStepOptions(data) {
        if (data.options) {
            this.showOptions(data.options, data.multi_select || false);
        }
    }
    
    // Step options
    showStep1Options() {
        this.displayMessage('é¦–å…ˆï¼Œè¯·é—®æ‚¨éœ€è¦å‡€åŒ–çš„ç©ºé—´é¢ç§¯å¤§çº¦æ˜¯å¤šå°‘ï¼Ÿ', 'bot');
        this.showOptions([
            { value: '20', label: '20ã¡ä»¥ä¸‹', description: 'å°å§å®¤/ä¹¦æˆ¿' },
            { value: '30', label: '20-40ã¡', description: 'å§å®¤/å°å®¢å…' },
            { value: '50', label: '40-60ã¡', description: 'å®¢å…/å¤§å§å®¤' },
            { value: '80', label: '60-100ã¡', description: 'å¤§å®¢å…/å¼€æ”¾ç©ºé—´' },
            { value: '120', label: '100ã¡ä»¥ä¸Š', description: 'å…¨å±‹/å¤§å‹ç©ºé—´' }
        ]);
    }
    
    showStep2Options() {
        this.showOptions([
            { value: 'north', label: 'åŒ—æ–¹åœ°åŒº', description: 'äº¬æ´¥å†€ã€ä¸œåŒ—ç­‰' },
            { value: 'south', label: 'å—æ–¹åœ°åŒº', description: 'é•¿ä¸‰è§’ã€ç ä¸‰è§’ç­‰' },
            { value: 'coastal', label: 'æ²¿æµ·åœ°åŒº', description: 'æ²¿æµ·åŸå¸‚' },
            { value: 'inland', label: 'å†…é™†åœ°åŒº', description: 'ä¸­éƒ¨å†…é™†' },
            { value: 'industrial', label: 'å·¥ä¸šåŒºé™„è¿‘', description: 'å·¥ä¸šå›­åŒºå‘¨è¾¹' }
        ]);
    }
    
    showStep3Options() {
        this.showOptions([
            { value: 'pm25', label: 'PM2.5/é›¾éœ¾', icon: 'ğŸŒ«ï¸' },
            { value: 'formaldehyde', label: 'ç”²é†›/è£…ä¿®æ±¡æŸ“', icon: 'ğŸ ' },
            { value: 'allergen', label: 'è¿‡æ•åŸ/èŠ±ç²‰', icon: 'ğŸŒ¸' },
            { value: 'bacteria', label: 'ç»†èŒ/ç—…æ¯’', icon: 'ğŸ¦ ' },
            { value: 'odor', label: 'å¼‚å‘³/çƒŸå‘³', icon: 'ğŸ’¨' },
            { value: 'dust', label: 'ç°å°˜/æ¯›å‘', icon: 'âœ¨' }
        ], true);
    }
    
    showStep4Options() {
        this.showOptions([
            { value: 'baby', label: 'å©´å¹¼å„¿', icon: 'ğŸ‘¶' },
            { value: 'elderly', label: 'è€å¹´äºº', icon: 'ğŸ‘´' },
            { value: 'pregnant', label: 'å­•å¦‡', icon: 'ğŸ¤°' },
            { value: 'allergy', label: 'è¿‡æ•äººç¾¤', icon: 'ğŸ¤§' },
            { value: 'respiratory', label: 'å‘¼å¸é“ç–¾ç—…æ‚£è€…', icon: 'ğŸ«' },
            { value: 'pet', label: 'å® ç‰©å®¶åº­', icon: 'ğŸ¾' },
            { value: 'general', label: 'æ™®é€šæˆäºº', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' }
        ], true);
    }
    
    showStep5Options() {
        this.showOptions([
            { value: 'bedroom', label: 'å§å®¤', description: 'éœ€è¦é™éŸ³è®¾è®¡' },
            { value: 'living', label: 'å®¢å…', description: 'éœ€è¦å¤§é£é‡' },
            { value: 'nursery', label: 'å©´å„¿æˆ¿', description: 'éœ€è¦è¶…é™éŸ³+å®‰å…¨' },
            { value: 'office', label: 'åŠå…¬å®¤', description: 'éœ€è¦é•¿æ—¶é—´è¿è¡Œ' },
            { value: 'whole_house', label: 'å…¨å±‹ä½¿ç”¨', description: 'éœ€è¦å¤§CADRå€¼' }
        ]);
    }
    
    showStep6Options() {
        this.showOptions([
            { value: 'economy', label: 'ç»æµå‹', range: '1000-2000å…ƒ' },
            { value: 'standard', label: 'æ ‡å‡†å‹', range: '2000-4000å…ƒ' },
            { value: 'premium', label: 'é«˜ç«¯å‹', range: '4000-8000å…ƒ' },
            { value: 'luxury', label: 'æ——èˆ°å‹', range: '8000å…ƒä»¥ä¸Š' }
        ]);
    }
    
    showRecommendations(data) {
        this.optionsContainer.innerHTML = '';
        this.displayMessage(data.message, 'bot');
        
        // Show result container
        setTimeout(() => {
            this.resultContainer.classList.remove('hidden');
            
            // Display profile summary
            if (data.user_profile_summary) {
                this.displayProfileSummary(data.user_profile_summary);
            }
            
            // Display recommendations
            if (data.recommendations) {
                this.displayRecommendedProducts(data.recommendations);
            }
            
            // Scroll to results
            this.resultContainer.scrollIntoView({ behavior: 'smooth' });
        }, 500);
    }
    
    displayProfileSummary(summary) {
        const container = document.getElementById('profile-details');
        container.innerHTML = `
            <div class="bg-white rounded-lg p-3">
                <div class="text-xs text-gray-500">ç©ºé—´é¢ç§¯</div>
                <div class="font-medium">${summary.area || '-'}</div>
            </div>
            <div class="bg-white rounded-lg p-3">
                <div class="text-xs text-gray-500">æ‰€åœ¨åŒºåŸŸ</div>
                <div class="font-medium">${summary.region || '-'}</div>
            </div>
            <div class="bg-white rounded-lg p-3">
                <div class="text-xs text-gray-500">ä½¿ç”¨ç©ºé—´</div>
                <div class="font-medium">${summary.space_type || '-'}</div>
            </div>
            <div class="bg-white rounded-lg p-3">
                <div class="text-xs text-gray-500">é¢„ç®—èŒƒå›´</div>
                <div class="font-medium">${summary.budget || '-'}</div>
            </div>
            <div class="bg-white rounded-lg p-3 col-span-2">
                <div class="text-xs text-gray-500">å…³æ³¨é—®é¢˜</div>
                <div class="font-medium">${(summary.problems || []).join('ã€') || '-'}</div>
            </div>
        `;
    }
    
    displayRecommendedProducts(recommendations) {
        const container = document.getElementById('recommended-products');
        container.innerHTML = '';
        
        recommendations.forEach((rec, index) => {
            const product = rec.product;
            const score = rec.score;
            const reasons = rec.match_reasons || [];
            
            const productCard = document.createElement('div');
            productCard.className = 'bg-gray-50 rounded-xl p-6 flex flex-col md:flex-row gap-6';
            
            productCard.innerHTML = `
                <div class="md:w-1/3">
                    <div class="relative">
                        <img src="${product.main_image || product.image}" alt="${product.name}" 
                             class="w-full h-48 object-contain bg-white rounded-lg"
                             onerror="this.src='https://via.placeholder.com/300x200?text=Product'">
                        <div class="absolute top-2 left-2 px-3 py-1 bg-accent-600 text-white text-sm font-medium rounded-full">
                            åŒ¹é…åº¦ ${score}%
                        </div>
                        ${index === 0 ? '<div class="absolute top-2 right-2 px-3 py-1 bg-primary-600 text-white text-sm font-medium rounded-full">æœ€ä½³æ¨è</div>' : ''}
                    </div>
                </div>
                <div class="md:w-2/3">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h3>
                    <div class="flex items-center space-x-2 mb-3">
                        <div class="flex items-center text-yellow-500">
                            <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                            <span class="ml-1 text-sm font-medium">${product.rating}</span>
                        </div>
                        <span class="text-gray-400 text-sm">(${product.reviews}æ¡è¯„ä»·)</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${(product.tags || []).map(tag => `<span class="px-2 py-1 bg-primary-50 text-primary-700 text-xs rounded-full">${tag}</span>`).join('')}
                    </div>
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">æ¨èç†ç”±ï¼š</h4>
                        <ul class="space-y-1">
                            ${reasons.map(reason => `
                                <li class="flex items-center text-sm text-gray-600">
                                    <i data-lucide="check" class="w-4 h-4 text-primary-600 mr-2"></i>
                                    ${reason}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <span class="text-3xl font-bold text-primary-600">Â¥${product.price}</span>
                            <span class="text-gray-400 line-through ml-2">Â¥${product.original_price}</span>
                        </div>
                        <a href="/product/${product.id}" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                            æŸ¥çœ‹è¯¦æƒ…
                        </a>
                    </div>
                </div>
            `;
            
            container.appendChild(productCard);
        });
        
        // Re-initialize Lucide icons
        lucide.createIcons();
    }
    
    generateLocalRecommendation() {
        // Local recommendation logic
        const products = [
            {
                id: 'pro-01',
                name: 'å‡€ç•Œè€…Â·æ£®æ—å‘¼å¸Pro',
                price: 2999,
                original_price: 3599,
                rating: 4.8,
                reviews: 5621,
                tags: ['é”€é‡å† å†›', 'é™¤é†›ä¸“å®¶', 'æ™ºèƒ½äº’è”'],
                image: '/static/images/products/pro.png'
            },
            {
                id: 'max-01',
                name: 'å‡€ç•Œè€…Â·æ¸…æ–°ä¹‹é£Max',
                price: 5999,
                original_price: 7299,
                rating: 4.9,
                reviews: 3892,
                tags: ['æ——èˆ°ä¹‹é€‰', 'å…¨èƒ½å‡€åŒ–', 'åŒ»ç–—çº§'],
                image: '/static/images/products/max.png'
            },
            {
                id: 'mini-01',
                name: 'å‡€ç•Œè€…Â·è‡ªç„¶å®ˆæŠ¤Mini',
                price: 1299,
                original_price: 1599,
                rating: 4.7,
                reviews: 2356,
                tags: ['å…¥é—¨é¦–é€‰', 'é™éŸ³è®¾è®¡', 'é«˜æ€§ä»·æ¯”'],
                image: '/static/images/products/mini.png'
            }
        ];
        
        const recommendations = products.map((product, index) => ({
            product: product,
            score: 95 - index * 10,
            match_reasons: [
                'é€‚ç”¨é¢ç§¯è¦†ç›–æ‚¨çš„ç©ºé—´',
                'æœ‰æ•ˆè§£å†³æ‚¨å…³æ³¨çš„ç©ºæ°”é—®é¢˜',
                'ç¬¦åˆæ‚¨çš„é¢„ç®—èŒƒå›´'
            ]
        }));
        
        this.showRecommendations({
            message: 'æ„Ÿè°¢æ‚¨çš„è€å¿ƒå›ç­”ï¼æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä¸ºæ‚¨ç²¾å¿ƒæŒ‘é€‰äº†ä»¥ä¸‹ç©ºæ°”ç®¡ç†æ–¹æ¡ˆï¼š',
            recommendations: recommendations,
            user_profile_summary: {
                area: this.userProfile.area + 'ã¡',
                region: this.getRegionName(this.userProfile.region),
                space_type: this.getSpaceName(this.userProfile.space),
                budget: this.getBudgetRange(this.userProfile.budget),
                problems: (this.userProfile.problems || []).map(p => this.getProblemName(p))
            }
        });
    }
    
    getRegionName(key) {
        const map = { north: 'åŒ—æ–¹åœ°åŒº', south: 'å—æ–¹åœ°åŒº', coastal: 'æ²¿æµ·åœ°åŒº', inland: 'å†…é™†åœ°åŒº', industrial: 'å·¥ä¸šåŒºé™„è¿‘' };
        return map[key] || key;
    }
    
    getSpaceName(key) {
        const map = { bedroom: 'å§å®¤', living: 'å®¢å…', nursery: 'å©´å„¿æˆ¿', office: 'åŠå…¬å®¤', whole_house: 'å…¨å±‹' };
        return map[key] || key;
    }
    
    getBudgetRange(key) {
        const map = { economy: '1000-2000å…ƒ', standard: '2000-4000å…ƒ', premium: '4000-8000å…ƒ', luxury: '8000å…ƒä»¥ä¸Š' };
        return map[key] || key;
    }
    
    getProblemName(key) {
        const map = { pm25: 'PM2.5/é›¾éœ¾', formaldehyde: 'ç”²é†›', allergen: 'è¿‡æ•åŸ', bacteria: 'ç»†èŒç—…æ¯’', odor: 'å¼‚å‘³', dust: 'ç°å°˜' };
        return map[key] || key;
    }
    
    handleInput() {
        const input = document.getElementById('guide-input');
        const value = input.value.trim();
        if (!value) return;
        
        this.displayMessage(value, 'user');
        input.value = '';
        this.processStep(value);
    }
    
    restart() {
        this.currentStep = 0;
        this.userProfile = {};
        this.messagesContainer.innerHTML = '';
        this.resultContainer.classList.add('hidden');
        this.updateProgress(0);
        this.startGuide();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    new SmartGuide();
});
</script>
{% endblock %}
